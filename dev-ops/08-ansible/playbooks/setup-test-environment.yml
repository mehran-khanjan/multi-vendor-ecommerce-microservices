---
- name: Setup Test Environment for MultiVendor Platform
  hosts: test_servers
  become: yes
  vars:
    service_name: "{{ service | default('all') }}"
    environment: "{{ env | default('test') }}"
    docker_registry: "{{ registry_url | default('registry.example.com') }}"
    docker_image_tag: "{{ image_tag | default('latest') }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == 'Debian'

    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg-agent
          - software-properties-common
        state: present
      when: ansible_os_family == 'Debian'

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      when: ansible_os_family == 'Debian'

    - name: Add Docker repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present
      when: ansible_os_family == 'Debian'

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
      when: ansible_os_family == 'Debian'

    - name: Install Docker Compose
      get_url:
        url: https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: Create docker group
      group:
        name: docker
        state: present

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create application directory
      file:
        path: "/opt/multivendor/{{ environment }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0755'

    - name: Create Docker Compose file
      template:
        src: "docker-compose-{{ environment }}.yml.j2"
        dest: "/opt/multivendor/{{ environment }}/docker-compose.yml"
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0644'

    - name: Create environment variables file
      template:
        src: "env-{{ environment }}.j2"
        dest: "/opt/multivendor/{{ environment }}/.env"
        owner: "{{ ansible_user }}"
        group: docker
        mode: '0600'

    - name: Login to Docker registry
      docker_login:
        registry: "{{ docker_registry }}"
        username: "{{ registry_username }}"
        password: "{{ registry_password }}"

    - name: Pull Docker images
      docker_compose:
        project_src: "/opt/multivendor/{{ environment }}"
        pull: yes

    - name: Start services with Docker Compose
      docker_compose:
        project_src: "/opt/multivendor/{{ environment }}"
        state: present

    - name: Wait for services to be ready
      wait_for:
        host: localhost
        port: "{{ item }}"
        delay: 10
        timeout: 300
      loop:
        - 4000  # API Gateway
        - 4001  # Auth Service
        - 5432  # PostgreSQL
        - 6379  # Redis

    - name: Run database migrations
      shell: |
        cd /opt/multivendor/{{ environment }} && \
        docker-compose exec auth-service yarn migration:run
      register: migration_result
      failed_when: migration_result.rc != 0
      changed_when: "'No migrations are pending' not in migration_result.stdout"

    - name: Run database seeds (test environment only)
      shell: |
        cd /opt/multivendor/{{ environment }} && \
        docker-compose exec auth-service yarn seed:run
      when: environment == 'test'
      register: seed_result
      failed_when: seed_result.rc != 0

    - name: Run health checks
      uri:
        url: "http://localhost:{{ item.port }}/health"
        method: GET
        status_code: 200
        timeout: 30
      loop:
        - { service: 'api-gateway', port: 4000 }
        - { service: 'auth-service', port: 4001 }
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 10

    - name: Install monitoring agent
      apt:
        name: node-exporter
        state: present
      when: environment != 'test'

    - name: Configure firewall
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - 22    # SSH
        - 4000  # API Gateway
        - 4001  # Auth Service
        - 9100  # Node Exporter

  handlers:
    - name: Restart Docker
      systemd:
        name: docker
        state: restarted
        daemon_reload: yes

    - name: Restart services
      docker_compose:
        project_src: "/opt/multivendor/{{ environment }}"
        state: restarted